<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Football Manager Ultimate</title>

<style>
/* ============ RESET & GLOBAL ============ */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    font-family: 'Arial', sans-serif;
    color: white;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

/* ============ LOADING ============ */
#loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(10, 10, 15, 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid #333;
    border-top-color: #00eaff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ============ LOGIN SCREEN ============ */
#login-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    padding: 20px;
}

#login-screen h2 {
    color: #00eaff;
    text-shadow: 0 0 10px #00eaff;
    margin-bottom: 30px;
    font-size: clamp(24px, 6vw, 32px);
    text-align: center;
}

#login-screen input {
    padding: 12px;
    width: min(320px, 90vw);
    margin: 10px 0;
    border-radius: 8px;
    border: 2px solid #6d00ff;
    background: rgba(26, 26, 37, 0.8);
    color: white;
    font-size: 16px;
    transition: all 0.3s;
}

#login-screen input:focus {
    outline: none;
    border-color: #00eaff;
    box-shadow: 0 0 10px #00eaff;
}

#login-screen button {
    padding: 12px;
    width: min(320px, 90vw);
    margin-top: 15px;
    background: #6d00ff;
    border: none;
    color: white;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

#login-screen button:hover {
    background: #8e38ff;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(109, 0, 255, 0.4);
}

#registerBtn {
    background: #1a1a25 !important;
}

#login-error {
    color: #ff4444;
    margin-top: 10px;
    text-align: center;
    max-width: min(320px, 90vw);
    font-size: 14px;
}

/* ============ GAME CONTAINER ============ */
#game-ui {
    display: none;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    position: fixed;
    top: 0;
    left: 0;
}

/* ============ TOP BAR ============ */
.top-bar {
    background: rgba(17, 17, 17, 0.95);
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #6d00ff;
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    width: 100%;
    height: 70px;
    flex-shrink: 0;
}

.player-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

#player-name {
    font-weight: bold;
    color: #00eaff;
    text-shadow: 0 0 8px #00eaff;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.money-box {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: nowrap;
}

.coin, .cash, .token {
    font-weight: bold;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

/* ============ NAVIGATION ============ */
.main-nav {
    display: flex;
    justify-content: space-around;
    background: rgba(17, 17, 17, 0.95);
    border-bottom: 2px solid #6d00ff;
    padding: 10px 5px;
    position: sticky;
    top: 70px;
    z-index: 99;
    height: 50px;
    flex-shrink: 0;
}

.nav-btn {
    background: none;
    color: #666;
    border: none;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    min-width: 60px;
    max-width: 80px;
    text-align: center;
    transition: all 0.3s;
}

.nav-btn i {
    font-size: 16px;
}

.nav-btn.active {
    color: #00eaff;
    text-shadow: 0 0 8px #00eaff;
    background: rgba(0, 234, 255, 0.1);
    transform: translateY(-2px);
}

/* ============ MAIN CONTENT ============ */
main {
    width: 100%;
    height: calc(100vh - 170px); /* 70px top + 50px nav + 50px bottom */
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 15px;
}

/* ============ SCREENS ============ */
.screen {
    display: none;
    width: 100%;
    min-height: 100%;
    animation: fadeIn 0.3s ease;
}

.screen.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.page-title {
    text-align: center;
    font-size: clamp(20px, 5vw, 24px);
    margin: 0 0 20px 0;
    color: white;
    text-shadow: 0 0 10px #6d00ff;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(109, 0, 255, 0.3);
}

/* ============ DASHBOARD ============ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(109, 0, 255, 0.3);
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #00eaff;
    text-shadow: 0 0 8px #00eaff;
    margin: 10px 0;
}

.stat-label {
    font-size: 14px;
    color: #aaa;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 20px;
}

.quick-btn {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 10px;
    padding: 15px 10px;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.quick-btn:hover {
    background: linear-gradient(145deg, #2b2b38, #1a1a25);
    transform: translateY(-2px);
    border-color: #00eaff;
}

.quick-btn i {
    font-size: 20px;
}

/* ============ MY TEAM ============ */
.formation-selector {
    background: rgba(26, 26, 37, 0.8);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    border: 2px solid #6d00ff;
}

.formation-options {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.formation-btn {
    background: #1a1a25;
    border: 2px solid #333;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
}

.formation-btn.active {
    border-color: #00eaff;
    background: rgba(0, 234, 255, 0.1);
}

.pitch-container {
    background: linear-gradient(to bottom, #1a472a, #0f2d1a);
    border: 3px solid #00eaff;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
    min-height: 500px;
}

.pitch {
    position: relative;
    width: 100%;
    height: 400px;
    background: linear-gradient(to bottom, #2e8b57, #1e5a3a);
    border: 2px solid white;
    border-radius: 10px;
    overflow: hidden;
}

.center-circle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    border: 2px solid white;
    border-radius: 50%;
}

.player-slot {
    position: absolute;
    width: 50px;
    height: 50px;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #00eaff;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 1;
}

.player-slot:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px #00eaff;
}

.player-slot.empty {
    background: rgba(255, 255, 255, 0.1);
    border-style: dashed;
}

.player-slot .position {
    font-size: 10px;
    color: #00eaff;
    font-weight: bold;
}

.player-slot .rating {
    font-size: 14px;
    font-weight: bold;
    color: white;
}

.team-management {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-top: 20px;
}

@media (min-width: 768px) {
    .team-management {
        grid-template-columns: 1fr 1fr;
    }
}

.player-list {
    background: rgba(26, 26, 37, 0.8);
    border-radius: 12px;
    padding: 15px;
    border: 2px solid #6d00ff;
    max-height: 300px;
    overflow-y: auto;
}

.player-item {
    background: #1a1a25;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s;
}

.player-item:hover {
    background: #2b2b38;
    border-color: #00eaff;
}

.player-info-small {
    display: flex;
    flex-direction: column;
}

.player-name {
    font-weight: bold;
    font-size: 14px;
}

.player-details {
    font-size: 12px;
    color: #aaa;
}

.player-rating {
    font-weight: bold;
    color: gold;
    font-size: 16px;
}

/* ============ COLLECTION ============ */
.filters {
    background: rgba(26, 26, 37, 0.8);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    border: 2px solid #6d00ff;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}

.filter-btn {
    background: #1a1a25;
    border: 2px solid #333;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 12px;
}

.filter-btn.active {
    border-color: #00eaff;
    background: rgba(0, 234, 255, 0.1);
}

.players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
}

.player-card {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.player-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(109, 0, 255, 0.3);
    border-color: #00eaff;
}

.player-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6d00ff, #00eaff);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 10px;
}

.player-rare-common { border-color: #aaa; }
.player-rare-rare { border-color: #00eaff; }
.player-rare-epic { border-color: #8e38ff; }
.player-rare-legendary { border-color: gold; }

.player-rare-common .player-photo { background: linear-gradient(135deg, #aaa, #666); }
.player-rare-rare .player-photo { background: linear-gradient(135deg, #00eaff, #0099cc); }
.player-rare-epic .player-photo { background: linear-gradient(135deg, #8e38ff, #6d00ff); }
.player-rare-legendary .player-photo { background: linear-gradient(135deg, gold, #ffaa00); }

.player-stats {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin-top: 10px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-value-small {
    font-size: 14px;
    font-weight: bold;
    color: #00eaff;
}

.stat-label-small {
    font-size: 10px;
    color: #aaa;
}

/* ============ STORE ============ */
.packs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.pack-card {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 3px solid;
    border-radius: 15px;
    padding: 25px 20px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.pack-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.pack-bronze { border-color: #cd7f32; }
.pack-silver { border-color: #c0c0c0; }
.pack-gold { border-color: gold; }
.pack-legendary { border-color: #ff00ff; }

.pack-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.pack-price {
    font-size: 20px;
    font-weight: bold;
    margin-top: 10px;
}

.pack-bronze .pack-price { color: #cd7f32; }
.pack-silver .pack-price { color: #c0c0c0; }
.pack-gold .pack-price { color: gold; }
.pack-legendary .pack-price { color: #ff00ff; }

/* ============ LEAGUE ============ */
.league-info {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}

.league-timer {
    font-size: 18px;
    font-weight: bold;
    color: #00eaff;
    margin: 15px 0;
}

.league-progress {
    background: #333;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin: 15px 0;
}

.league-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00eaff, #6d00ff);
    border-radius: 10px;
    transition: width 0.5s;
}

.weekly-matches {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.match-card {
    background: rgba(26, 26, 37, 0.8);
    border: 2px solid #333;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.match-result.win {
    border-color: #00ff00;
    background: rgba(0, 255, 0, 0.1);
}

.match-result.lose {
    border-color: #ff4444;
    background: rgba(255, 68, 68, 0.1);
}

.match-teams {
    display: flex;
    align-items: center;
    gap: 10px;
}

.vs {
    font-weight: bold;
    color: #00eaff;
}

.match-score {
    font-size: 18px;
    font-weight: bold;
}

/* ============ RANKING ============ */
.ranking-container {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.ranking-header {
    display: grid;
    grid-template-columns: 50px 1fr 100px;
    padding: 10px;
    border-bottom: 2px solid #333;
    font-weight: bold;
    color: #00eaff;
    margin-bottom: 10px;
}

.ranking-item {
    display: grid;
    grid-template-columns: 50px 1fr 100px;
    padding: 12px 10px;
    border-bottom: 1px solid #333;
    align-items: center;
}

.ranking-item.you {
    background: rgba(0, 234, 255, 0.1);
    border-left: 4px solid #00eaff;
}

.rank {
    font-size: 18px;
    font-weight: bold;
    text-align: center;
}

.rank-1 { color: gold; }
.rank-2 { color: silver; }
.rank-3 { color: #cd7f32; }

.player-rank-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.player-rank-name {
    font-weight: bold;
}

.player-rank-team {
    font-size: 12px;
    color: #aaa;
}

.player-rank-points {
    font-weight: bold;
    color: #00eaff;
    text-align: right;
}

/* ============ PROFILE ============ */
.profile-header {
    display: flex;
    align-items: center;
    gap: 20px;
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6d00ff, #00eaff);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
}

.profile-details {
    flex: 1;
}

.profile-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.badges-container {
    background: rgba(26, 26, 37, 0.8);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #6d00ff;
    margin-top: 20px;
}

.badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.badge {
    background: #1a1a25;
    border: 2px solid #333;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.badge.unlocked {
    border-color: gold;
    background: rgba(255, 215, 0, 0.1);
}

/* ============ BOTTOM NAV ============ */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(17, 17, 17, 0.95);
    display: flex;
    justify-content: space-around;
    padding: 12px 5px;
    border-top: 2px solid #6d00ff;
    backdrop-filter: blur(10px);
    z-index: 100;
    height: 50px;
    flex-shrink: 0;
}

.bottom-nav-btn {
    background: none;
    color: #666;
    border: none;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    min-width: 60px;
    max-width: 80px;
    text-align: center;
    transition: all 0.3s;
}

.bottom-nav-btn.active {
    color: #00eaff;
    text-shadow: 0 0 8px #00eaff;
    background: rgba(0, 234, 255, 0.1);
}

/* ============ MODALS ============ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal-content {
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 3px solid #6d00ff;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    animation: modalPop 0.3s ease;
}

@keyframes modalPop {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
}

/* ============ NOTIFICATIONS ============ */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    left: 20px;
    background: linear-gradient(145deg, #1a1a25, #0f0f18);
    border: 2px solid #6d00ff;
    border-radius: 10px;
    padding: 15px;
    color: white;
    z-index: 10000;
    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
    animation-fill-mode: forwards;
    max-width: calc(100vw - 40px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    word-wrap: break-word;
}

@keyframes slideIn {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* ============ SCROLLBAR ============ */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(26, 26, 37, 0.5);
}

::-webkit-scrollbar-thumb {
    background: #6d00ff;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: #8e38ff;
}

/* ============ RESPONSIVE ============ */
@media (max-width: 768px) {
    .packs-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .players-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    }
    
    .formation-options {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
    }
    
    .player-slot {
        width: 40px;
        height: 40px;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .quick-actions {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .nav-btn, .bottom-nav-btn {
        font-size: 10px;
        min-width: 50px;
        padding: 6px 8px;
    }
    
    .pitch {
        height: 300px;
    }
}
</style>

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>

<!-- Loading Screen -->
<div id="loading">
    <div class="loading-spinner"></div>
    <div style="margin-top: 20px; color: #00eaff;">Chargement du Football Manager...</div>
</div>

<!-- Login Screen -->
<div id="login-screen">
    <h2>FOOTBALL MANAGER ULTIMATE</h2>
    <input id="email" type="email" placeholder="Email" value="test@test.com">
    <input id="password" type="password" placeholder="Mot de passe" value="test123">
    <button id="loginBtn">SE CONNECTER</button>
    <button id="registerBtn">Cr√©er un compte</button>
    <div id="login-error">Utilisez test@test.com / test123 pour tester</div>
</div>

<!-- Main Game Interface -->
<div id="game-ui" style="display:none;">

<!-- Top Bar -->
<header class="top-bar">
    <div class="player-info">
        <span id="player-name">Joueur</span>
        <div class="xp-bar" style="width: 100px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
            <div id="xp-fill" style="height: 100%; background: linear-gradient(90deg, #00eaff, #6d00ff); width: 30%;"></div>
        </div>
        <span id="player-level">Niv. 1</span>
    </div>
    
    <div class="money-box">
        <span class="coin">üí∞ <span id="coins">0</span></span>
        <span class="cash">üíé <span id="gems">0</span></span>
        <span class="token">üèÜ <span id="tokens">0</span></span>
    </div>
</header>

<!-- Main Navigation -->
<nav class="main-nav">
    <button class="nav-btn active" data-target="screen-dashboard">
        <i class="fas fa-tachometer-alt"></i>
        Dashboard
    </button>
    <button class="nav-btn" data-target="screen-team">
        <i class="fas fa-users"></i>
        Mon √âquipe
    </button>
    <button class="nav-btn" data-target="screen-collection">
        <i class="fas fa-layer-group"></i>
        Collection
    </button>
    <button class="nav-btn" data-target="screen-store">
        <i class="fas fa-shopping-cart"></i>
        Boutique
    </button>
    <button class="nav-btn" data-target="screen-league">
        <i class="fas fa-trophy"></i>
        Ligue
    </button>
</nav>

<!-- Main Content -->
<main>
    <!-- Dashboard -->
    <section id="screen-dashboard" class="screen active">
        <h2 class="page-title">TABLEAU DE BORD</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Niveau</div>
                <div class="stat-value" id="stat-level">1</div>
                <div class="stat-label">Exp√©rience</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Victoires</div>
                <div class="stat-value" id="stat-wins">0</div>
                <div class="stat-label">D√©faites</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Points Ligue</div>
                <div class="stat-value" id="stat-league-points">0</div>
                <div class="stat-label">Classement</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Joueurs</div>
                <div class="stat-value" id="stat-players">0</div>
                <div class="stat-label">Collection</div>
            </div>
        </div>
        
        <div class="quick-actions">
            <button class="quick-btn" id="quick-play">
                <i class="fas fa-play"></i>
                Jouer Match
            </button>
            <button class="quick-btn" id="quick-pack">
                <i class="fas fa-gift"></i>
                Ouvrir Pack
            </button>
            <button class="quick-btn" id="quick-daily">
                <i class="fas fa-calendar-day"></i>
                R√©compense
            </button>
            <button class="quick-btn" id="quick-ranking">
                <i class="fas fa-chart-line"></i>
                Classement
            </button>
        </div>
        
        <div style="margin-top: 30px; background: rgba(26,26,37,0.8); border-radius: 12px; padding: 20px; border: 2px solid #6d00ff;">
            <h3 style="margin-bottom: 15px; color: #00eaff;">Prochain Match</h3>
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-weight: bold;">Votre √âquipe</div>
                    <div style="font-size: 24px; font-weight: bold; color: #00eaff;">VS</div>
                    <div style="font-weight: bold;">Adversaire</div>
                </div>
                <button id="play-next-match" style="background: #6d00ff; border: none; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    JOUER
                </button>
            </div>
        </div>
    </section>

    <!-- My Team -->
    <section id="screen-team" class="screen">
        <h2 class="page-title">MON √âQUIPE</h2>
        
        <div class="formation-selector">
            <h3 style="margin-bottom: 10px; color: #00eaff;">Formation</h3>
            <div class="formation-options">
                <button class="formation-btn active" data-formation="4-3-3">4-3-3</button>
                <button class="formation-btn" data-formation="4-4-2">4-4-2</button>
                <button class="formation-btn" data-formation="4-2-3-1">4-2-3-1</button>
                <button class="formation-btn" data-formation="3-5-2">3-5-2</button>
                <button class="formation-btn" data-formation="5-3-2">5-3-2</button>
            </div>
        </div>
        
        <div class="pitch-container">
            <div class="pitch" id="football-pitch">
                <!-- Player slots will be dynamically added here -->
                <div class="center-circle"></div>
            </div>
        </div>
        
        <div class="team-management">
            <div class="player-list">
                <h3 style="margin-bottom: 10px; color: #00eaff;">Joueurs Disponibles</h3>
                <div id="available-players-list">
                    <!-- Available players will be loaded here -->
                </div>
            </div>
            
            <div class="player-list">
                <h3 style="margin-bottom: 10px; color: #00eaff;">√âquipe Actuelle</h3>
                <div id="current-team-list">
                    <!-- Current team players will be loaded here -->
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button id="save-team" style="background: #00eaff; border: none; color: #0a0a0f; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
                <i class="fas fa-save"></i> Sauvegarder l'√âquipe
            </button>
        </div>
    </section>

    <!-- Collection -->
    <section id="screen-collection" class="screen">
        <h2 class="page-title">COLLECTION</h2>
        
        <div class="filters">
            <button class="filter-btn active" data-filter="all">Tous</button>
            <button class="filter-btn" data-filter="common">Commun (‚òÖ)</button>
            <button class="filter-btn" data-filter="rare">Rare (‚òÖ‚òÖ)</button>
            <button class="filter-btn" data-filter="epic">√âpique (‚òÖ‚òÖ‚òÖ)</button>
            <button class="filter-btn" data-filter="legendary">L√©gendaire (‚òÖ‚òÖ‚òÖ‚òÖ)</button>
            <button class="filter-btn" data-filter="att">Attaquant</button>
            <button class="filter-btn" data-filter="mid">Milieu</button>
            <button class="filter-btn" data-filter="def">D√©fenseur</button>
            <button class="filter-btn" data-filter="gk">Gardien</button>
        </div>
        
        <div class="players-grid" id="collection-players">
            <!-- Player cards will be dynamically added here -->
        </div>
    </section>

    <!-- Store -->
    <section id="screen-store" class="screen">
        <h2 class="page-title">BOUTIQUE</h2>
        
        <div class="packs-grid">
            <div class="pack-card pack-bronze" data-pack="bronze">
                <div class="pack-icon">ü•â</div>
                <h3>PACK BRONZE</h3>
                <p>3 joueurs al√©atoires<br>1 joueur rare garanti</p>
                <div class="pack-price">üí∞ 500</div>
                <small>Cliquez pour acheter</small>
            </div>
            
            <div class="pack-card pack-silver" data-pack="silver">
                <div class="pack-icon">ü•à</div>
                <h3>PACK ARGENT</h3>
                <p>5 joueurs al√©atoires<br>1 joueur √©pique garanti</p>
                <div class="pack-price">üí∞ 1,500</div>
                <small>Cliquez pour acheter</small>
            </div>
            
            <div class="pack-card pack-gold" data-pack="gold">
                <div class="pack-icon">ü•á</div>
                <h3>PACK OR</h3>
                <p>7 joueurs al√©atoires<br>1 joueur l√©gendaire garanti</p>
                <div class="pack-price">üíé 50</div>
                <small>Cliquez pour acheter</small>
            </div>
            
            <div class="pack-card pack-legendary" data-pack="legendary">
                <div class="pack-icon">üëë</div>
                <h3>PACK L√âGENDAIRE</h3>
                <p>10 joueurs al√©atoires<br>3 l√©gendaires garantis</p>
                <div class="pack-price">üíé 150</div>
                <small>Cliquez pour acheter</small>
            </div>
        </div>
        
        <div style="margin-top: 40px; background: rgba(26,26,37,0.8); border-radius: 12px; padding: 20px; border: 2px solid #6d00ff;">
            <h3 style="margin-bottom: 15px; color: #00eaff;">Acheter des Devises</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <button class="quick-btn buy-currency" data-amount="500" data-price="100">
                    <div>üí∞ 500 Coins</div>
                    <small>100 gems</small>
                </button>
                <button class="quick-btn buy-currency" data-amount="1500" data-price="250">
                    <div>üí∞ 1,500 Coins</div>
                    <small>250 gems</small>
                </button>
                <button class="quick-btn buy-currency" data-amount="5000" data-price="750">
                    <div>üí∞ 5,000 Coins</div>
                    <small>750 gems</small>
                </button>
            </div>
        </div>
    </section>

    <!-- League -->
    <section id="screen-league" class="screen">
        <h2 class="page-title">LIGUE HEBDO</h2>
        
        <div class="league-info">
            <h3 style="color: #00eaff; margin-bottom: 10px;">Ligue Diamant</h3>
            <div class="league-timer" id="league-timer">
                Reset dans: 2j 14h 30m
            </div>
            <div class="league-progress">
                <div class="league-progress-fill" id="league-progress" style="width: 65%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <span>Promotion: 1800 pts</span>
                <span id="current-points">1,170 pts</span>
                <span>Rel√©gation: 800 pts</span>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="play-league-match" style="background: linear-gradient(135deg, #00eaff, #6d00ff); border: none; color: white; padding: 15px 40px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px;">
                <i class="fas fa-play-circle"></i> Jouer un Match de Ligue
            </button>
        </div>
        
        <h3 style="margin: 25px 0 15px 0; color: #00eaff;">Matches de la Semaine</h3>
        <div class="weekly-matches" id="weekly-matches">
            <!-- Weekly matches will be loaded here -->
        </div>
    </section>

    <!-- Ranking -->
    <section id="screen-ranking" class="screen">
        <h2 class="page-title">CLASSEMENT MONDIAL</h2>
        
        <div class="ranking-container">
            <div class="ranking-header">
                <div>Rang</div>
                <div>Joueur</div>
                <div>Points</div>
            </div>
            <div id="global-ranking">
                <!-- Ranking will be loaded here -->
            </div>
        </div>
        
        <div style="margin-top: 30px; background: rgba(26,26,37,0.8); border-radius: 12px; padding: 20px; border: 2px solid #6d00ff;">
            <h3 style="margin-bottom: 15px; color: #00eaff;">Votre Position</h3>
            <div id="your-ranking" style="text-align: center; font-size: 24px; font-weight: bold; color: #00eaff;">
                Chargement...
            </div>
        </div>
    </section>

    <!-- Profile -->
    <section id="screen-profile" class="screen">
        <h2 class="page-title">PROFIL</h2>
        
        <div class="profile-header">
            <div class="profile-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="profile-details">
                <h3 id="profile-name" style="color: #00eaff;">Joueur</h3>
                <p id="profile-email">test@test.com</p>
                <p>Membre depuis: <span id="member-since">Aujourd'hui</span></p>
            </div>
        </div>
        
        <div class="profile-stats-grid">
            <div class="stat-card">
                <div class="stat-label">Matches Jou√©s</div>
                <div class="stat-value" id="profile-matches">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Taux de Victoire</div>
                <div class="stat-value" id="profile-winrate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Buts Marqu√©s</div>
                <div class="stat-value" id="profile-goals">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Buts Encais√©s</div>
                <div class="stat-value" id="profile-goals-conceded">0</div>
            </div>
        </div>
        
        <div class="badges-container">
            <h3 style="color: #00eaff; margin-bottom: 15px;">Badges Obtenus</h3>
            <div class="badges-grid" id="profile-badges">
                <!-- Badges will be loaded here -->
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button id="logout-btn" style="background: #ff4444; border: none; color: white; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> D√©connexion
            </button>
        </div>
    </section>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="bottom-nav-btn" data-target="screen-ranking">
        <i class="fas fa-chart-line"></i>
        Classement
    </button>
    <button class="bottom-nav-btn" data-target="screen-profile">
        <i class="fas fa-user"></i>
        Profil
    </button>
    <button class="bottom-nav-btn" id="open-settings">
        <i class="fas fa-cog"></i>
        Param√®tres
    </button>
</nav>

<!-- Pack Opening Modal -->
<div id="pack-modal" class="modal">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2 style="color: #00eaff; text-align: center; margin-bottom: 20px;" id="pack-modal-title">Ouverture de Pack</h2>
        <div id="pack-results" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px;">
            <!-- Pack results will appear here -->
        </div>
    </div>
</div>

<!-- Player Details Modal -->
<div id="player-modal" class="modal">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <div id="player-modal-content">
            <!-- Player details will appear here -->
        </div>
    </div>
</div>

<!-- Match Result Modal -->
<div id="match-modal" class="modal">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2 style="color: #00eaff; text-align: center; margin-bottom: 20px;" id="match-result-title">R√©sultat du Match</h2>
        <div id="match-result-content" style="text-align: center;">
            <!-- Match result will appear here -->
        </div>
    </div>
</div>

<!-- Fusion Animation Modal -->
<div id="fusion-modal" class="modal">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2 style="color: #00eaff; text-align: center; margin-bottom: 20px;">Fusion R√©ussie!</h2>
        <div id="fusion-content" style="text-align: center;">
            <!-- Fusion animation will appear here -->
        </div>
    </div>
</div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBnDW725laagCdj0INT9gaA2z0FsLn6cO4",
    authDomain: "defi-amis-plus.firebaseapp.com",
    databaseURL: "https://defi-amis-plus-default-rtdb.firebaseio.com",
    projectId: "defi-amis-plus",
    storageBucket: "defi-amis-plus.appspot.com",
    messagingSenderId: "714241330241",
    appId: "1:714241330241:web:b927c37c0d511e66f64ac0"
};

// Variables globales
let firebaseApp, firebaseAuth, firebaseDb;
let currentUser = null;

// D√©finir les donn√©es par d√©faut AVEC LE SYST√àME DE FUSION
const defaultUserData = {
    coins: 1000,
    gems: 50,
    tokens: 0,
    level: 1,
    xp: 0,
    // NOUVELLE STRUCTURE: joueurs avec compteur et niveau
    players: {
        "GK001": { count: 1, level: 1 },
        "DEF001": { count: 1, level: 1 },
        "DEF002": { count: 1, level: 1 },
        "MID001": { count: 1, level: 1 },
        "MID002": { count: 1, level: 1 },
        "ATT001": { count: 1, level: 1 },
        "ATT002": { count: 1, level: 1 }
    },
    // √âquipe avec niveau individuel
    team: {
        GK: { id: "GK001", level: 1 },
        RB: { id: "DEF002", level: 1 },
        CB1: { id: "DEF001", level: 1 },
        CB2: { id: "DEF002", level: 1 },
        LB: { id: "DEF001", level: 1 },
        CM1: { id: "MID001", level: 1 },
        CM2: { id: "MID002", level: 1 },
        CM3: { id: "MID001", level: 1 },
        RW: { id: "ATT003", level: 1 },
        ST: { id: "ATT001", level: 1 },
        LW: { id: "ATT005", level: 1 }
    },
    formation: "4-3-3",
    leaguePoints: 1000,
    matchesPlayed: 0,
    wins: 0,
    draws: 0,
    losses: 0,
    goalsScored: 0,
    goalsConceded: 0,
    badges: ["badge_rookie"],
    joinDate: new Date().toISOString(),
    weeklyMatches: [],
    ranking: 9999,
    // NOUVEAU: Derni√®re r√©compense quotidienne
    lastDailyReward: null
};

let userData = { ...defaultUserData };

// Base de donn√©es des joueurs de football
const footballPlayersDB = {
    common: [
        // Gardiens
        { id: "GK001", name: "Mike Maignan", position: "GK", overall: 87, rarity: "common", nation: "France", club: "AC Milan", att: 40, def: 85, phy: 88, pac: 65, dri: 60, sho: 45, pas: 55 },
        { id: "GK002", name: "Gianluigi Donnarumma", position: "GK", overall: 86, rarity: "common", nation: "Italie", club: "PSG", att: 35, def: 86, phy: 90, pac: 60, dri: 55, sho: 40, pas: 50 },
        
        // D√©fenseurs
        { id: "DEF001", name: "Virgil van Dijk", position: "CB", overall: 89, rarity: "common", nation: "Pays-Bas", club: "Liverpool", att: 60, def: 90, phy: 92, pac: 75, dri: 70, sho: 65, pas: 72 },
        { id: "DEF002", name: "Ruben Dias", position: "CB", overall: 88, rarity: "common", nation: "Portugal", club: "Man City", att: 55, def: 89, phy: 85, pac: 70, dri: 68, sho: 60, pas: 70 },
        { id: "DEF003", name: "Trent Alexander-Arnold", position: "RB", overall: 87, rarity: "common", nation: "Angleterre", club: "Liverpool", att: 75, def: 82, phy: 78, pac: 82, dri: 84, sho: 76, pas: 90 },
        
        // Milieux
        { id: "MID001", name: "Kevin De Bruyne", position: "CM", overall: 91, rarity: "common", nation: "Belgique", club: "Man City", att: 88, def: 65, phy: 82, pac: 75, dri: 88, sho: 89, pas: 94 },
        { id: "MID002", name: "Luka Modriƒá", position: "CM", overall: 88, rarity: "common", nation: "Croatie", club: "Real Madrid", att: 82, def: 70, phy: 75, pac: 72, dri: 90, sho: 82, pas: 89 },
        
        // Attaquants
        { id: "ATT001", name: "Kylian Mbapp√©", position: "ST", overall: 91, rarity: "common", nation: "France", club: "PSG", att: 92, def: 35, phy: 82, pac: 97, dri: 92, sho: 90, pas: 80 },
        { id: "ATT002", name: "Erling Haaland", position: "ST", overall: 91, rarity: "common", nation: "Norv√®ge", club: "Man City", att: 93, def: 45, phy: 94, pac: 89, dri: 80, sho: 94, pas: 65 },
        { id: "ATT003", name: "Lionel Messi", position: "RW", overall: 91, rarity: "common", nation: "Argentine", club: "Inter Miami", att: 90, def: 38, phy: 72, pac: 81, dri: 95, sho: 90, pas: 91 },
        { id: "ATT004", name: "Cristiano Ronaldo", position: "ST", overall: 90, rarity: "common", nation: "Portugal", club: "Al Nassr", att: 92, def: 42, phy: 87, pac: 84, dri: 88, sho: 92, pas: 81 },
        { id: "ATT005", name: "Neymar Jr", position: "LW", overall: 89, rarity: "common", nation: "Br√©sil", club: "Al Hilal", att: 88, def: 36, phy: 68, pac: 87, dri: 95, sho: 84, pas: 86 },
        { id: "ATT006", name: "Harry Kane", position: "ST", overall: 89, rarity: "common", nation: "Angleterre", club: "Bayern Munich", att: 91, def: 48, phy: 86, pac: 78, dri: 82, sho: 91, pas: 85 },
        { id: "ATT007", name: "Karim Benzema", position: "ST", overall: 89, rarity: "common", nation: "France", club: "Al Ittihad", att: 90, def: 45, phy: 82, pac: 77, dri: 88, sho: 89, pas: 83 },
        { id: "ATT008", name: "Robert Lewandowski", position: "ST", overall: 89, rarity: "common", nation: "Pologne", club: "Barcelona", att: 91, def: 44, phy: 84, pac: 76, dri: 85, sho: 91, pas: 79 },
        { id: "ATT009", name: "Mohamed Salah", position: "RW", overall: 88, rarity: "common", nation: "√âgypte", club: "Liverpool", att: 89, def: 45, phy: 80, pac: 90, dri: 88, sho: 88, pas: 81 },
        { id: "ATT010", name: "Son Heung-min", position: "LW", overall: 88, rarity: "common", nation: "Cor√©e du Sud", club: "Tottenham", att: 88, def: 42, phy: 76, pac: 89, dri: 86, sho: 88, pas: 82 }
    ],
    rare: [
        { id: "R001", name: "Jude Bellingham", position: "CM", overall: 90, rarity: "rare", nation: "Angleterre", club: "Real Madrid", att: 86, def: 72, phy: 88, pac: 82, dri: 89, sho: 84, pas: 86 },
        { id: "R002", name: "Vin√≠cius J√∫nior", position: "LW", overall: 89, rarity: "rare", nation: "Br√©sil", club: "Real Madrid", att: 88, def: 32, phy: 75, pac: 95, dri: 91, sho: 83, pas: 78 },
        { id: "R003", name: "Phil Foden", position: "CAM", overall: 88, rarity: "rare", nation: "Angleterre", club: "Man City", att: 86, def: 52, phy: 70, pac: 80, dri: 89, sho: 84, pas: 85 },
        { id: "R004", name: "Rodri", position: "CDM", overall: 90, rarity: "rare", nation: "Espagne", club: "Man City", att: 72, def: 88, phy: 87, pac: 65, dri: 78, sho: 72, pas: 84 },
        { id: "R005", name: "Joshua Kimmich", position: "CDM", overall: 88, rarity: "rare", nation: "Allemagne", club: "Bayern Munich", att: 75, def: 85, phy: 82, pac: 72, dri: 83, sho: 76, pas: 88 }
    ],
    epic: [
        { id: "E001", name: "Pel√©", position: "ST", overall: 95, rarity: "epic", nation: "Br√©sil", club: "L√©gende", att: 96, def: 40, phy: 85, pac: 95, dri: 97, sho: 95, pas: 90 },
        { id: "E002", name: "Diego Maradona", position: "CAM", overall: 95, rarity: "epic", nation: "Argentine", club: "L√©gende", att: 92, def: 50, phy: 80, pac: 90, dri: 98, sho: 88, pas: 92 },
        { id: "E003", name: "Zinedine Zidane", position: "CAM", overall: 94, rarity: "epic", nation: "France", club: "L√©gende", att: 88, def: 65, phy: 85, pac: 75, dri: 92, sho: 85, pas: 93 },
        { id: "E004", name: "Ronaldo Naz√°rio", position: "ST", overall: 94, rarity: "epic", nation: "Br√©sil", club: "L√©gende", att: 95, def: 30, phy: 90, pac: 96, dri: 92, sho: 94, pas: 75 },
        { id: "E005", name: "Johan Cruyff", position: "CF", overall: 93, rarity: "epic", nation: "Pays-Bas", club: "L√©gende", att: 90, def: 55, phy: 75, pac: 85, dri: 95, sho: 86, pas: 92 }
    ],
    legendary: [
        { id: "L001", name: "Lionel Messi (Prime)", position: "RW", overall: 98, rarity: "legendary", nation: "Argentine", club: "L√©gende", att: 96, def: 35, phy: 75, pac: 88, dri: 99, sho: 94, pas: 95 },
        { id: "L002", name: "Cristiano Ronaldo (Prime)", position: "ST", overall: 97, rarity: "legendary", nation: "Portugal", club: "L√©gende", att: 97, def: 40, phy: 90, pac: 92, dri: 91, sho: 96, pas: 84 },
        { id: "L003", name: "Pel√© (Prime)", position: "ST", overall: 98, rarity: "legendary", nation: "Br√©sil", club: "L√©gende", att: 98, def: 42, phy: 88, pac: 97, dri: 98, sho: 96, pas: 92 }
    ]
};

// Formations avec positions
const formations = {
    "4-3-3": {
        positions: [
            {x: 50, y: 90, pos: "GK"}, // Gardien
            {x: 25, y: 70, pos: "RB"}, {x: 40, y: 70, pos: "CB"}, {x: 60, y: 70, pos: "CB"}, {x: 75, y: 70, pos: "LB"}, // D√©fense
            {x: 30, y: 50, pos: "CM"}, {x: 50, y: 50, pos: "CM"}, {x: 70, y: 50, pos: "CM"}, // Milieu
            {x: 25, y: 25, pos: "RW"}, {x: 50, y: 20, pos: "ST"}, {x: 75, y: 25, pos: "LW"} // Attaque
        ]
    },
    "4-4-2": {
        positions: [
            {x: 50, y: 90, pos: "GK"},
            {x: 25, y: 70, pos: "RB"}, {x: 40, y: 70, pos: "CB"}, {x: 60, y: 70, pos: "CB"}, {x: 75, y: 70, pos: "LB"},
            {x: 25, y: 50, pos: "RM"}, {x: 40, y: 50, pos: "CM"}, {x: 60, y: 50, pos: "CM"}, {x: 75, y: 50, pos: "LM"},
            {x: 35, y: 25, pos: "ST"}, {x: 65, y: 25, pos: "ST"}
        ]
    },
    "4-2-3-1": {
        positions: [
            {x: 50, y: 90, pos: "GK"},
            {x: 25, y: 70, pos: "RB"}, {x: 40, y: 70, pos: "CB"}, {x: 60, y: 70, pos: "CB"}, {x: 75, y: 70, pos: "LB"},
            {x: 35, y: 55, pos: "CDM"}, {x: 65, y: 55, pos: "CDM"},
            {x: 25, y: 40, pos: "RM"}, {x: 50, y: 35, pos: "CAM"}, {x: 75, y: 40, pos: "LM"},
            {x: 50, y: 20, pos: "ST"}
        ]
    },
    "3-5-2": {
        positions: [
            {x: 50, y: 90, pos: "GK"},
            {x: 35, y: 70, pos: "CB"}, {x: 50, y: 70, pos: "CB"}, {x: 65, y: 70, pos: "CB"},
            {x: 20, y: 55, pos: "RM"}, {x: 35, y: 55, pos: "CM"}, {x: 50, y: 55, pos: "CM"}, {x: 65, y: 55, pos: "CM"}, {x: 80, y: 55, pos: "LM"},
            {x: 40, y: 25, pos: "ST"}, {x: 60, y: 25, pos: "ST"}
        ]
    },
    "5-3-2": {
        positions: [
            {x: 50, y: 90, pos: "GK"},
            {x: 20, y: 70, pos: "RWB"}, {x: 35, y: 70, pos: "CB"}, {x: 50, y: 70, pos: "CB"}, {x: 65, y: 70, pos: "CB"}, {x: 80, y: 70, pos: "LWB"},
            {x: 35, y: 50, pos: "CM"}, {x: 50, y: 50, pos: "CM"}, {x: 65, y: 50, pos: "CM"},
            {x: 40, y: 25, pos: "ST"}, {x: 60, y: 25, pos: "ST"}
        ]
    }
};

// Badges disponibles
const badges = [
    {id: "badge_rookie", name: "D√©butant", icon: "ü•≥", description: "Premi√®re connexion", unlocked: true},
    {id: "badge_first_win", name: "Premi√®re Victoire", icon: "üèÜ", description: "Gagner son premier match", unlocked: false},
    {id: "badge_10wins", name: "Vainqueur", icon: "üëë", description: "10 victoires", unlocked: false},
    {id: "badge_50wins", name: "Champion", icon: "üèÖ", description: "50 victoires", unlocked: false},
    {id: "badge_legendary", name: "L√©gende", icon: "‚≠ê", description: "Obtenir un joueur l√©gendaire", unlocked: false},
    {id: "badge_collector", name: "Collectionneur", icon: "üìö", description: "20 joueurs dans la collection", unlocked: false},
    {id: "badge_rich", name: "Millionnaire", icon: "üí∞", description: "10 000 coins", unlocked: false},
    {id: "badge_league", name: "Ligue Diamant", icon: "üíé", description: "Atteindre la ligue diamant", unlocked: false}
];

// Initialisation de l'application
function initializeApp() {
    console.log("Initialisation du Football Manager...");
    
    try {
        // Initialiser Firebase
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebase.auth();
        firebaseDb = firebase.database();
        console.log("Firebase initialis√© avec succ√®s!");
        
        // Initialiser les √©v√©nements
        initializeEventHandlers();
        
        // Observer les changements d'authentification
        firebaseAuth.onAuthStateChanged(handleAuthStateChanged);
        
        // V√©rifier la connexion existante
        if (firebaseAuth.currentUser) {
            console.log("Utilisateur d√©j√† connect√©:", firebaseAuth.currentUser.email);
        }
        
    } catch (error) {
        console.error("Erreur d'initialisation:", error);
        showNotification("Erreur d'initialisation: " + error.message, "error");
    }
}

// G√©rer les changements d'authentification
async function handleAuthStateChanged(user) {
    const loginScreen = document.getElementById("login-screen");
    const gameUI = document.getElementById("game-ui");
    
    if (user) {
        // Utilisateur connect√©
        console.log("Utilisateur connect√©:", user.email);
        currentUser = user;
        
        // Charger les donn√©es utilisateur
        await loadUserData(user.uid);
        
        // Afficher l'interface du jeu
        loginScreen.style.display = "none";
        gameUI.style.display = "block";
        
        // Initialiser les interfaces
        initializeGameInterfaces();
        updateDashboard();
        updateTeamDisplay();
        updateCollectionDisplay();
        updateLeagueTimer();
        updateGlobalRanking();
        updateProfile();
        
        showNotification("Connexion r√©ussie! Bienvenue " + user.email, "success");
        
    } else {
        // Utilisateur d√©connect√©
        console.log("Utilisateur d√©connect√©");
        currentUser = null;
        gameUI.style.display = "none";
        loginScreen.style.display = "flex";
    }
    
    hideLoading();
}

// Charger les donn√©es utilisateur - AVEC NOUVELLE STRUCTURE
async function loadUserData(userId) {
    try {
        const snapshot = await firebaseDb.ref(`users/${userId}`).once('value');
        
        if (snapshot.exists()) {
            // Fusionner les donn√©es charg√©es avec les valeurs par d√©faut
            const loadedData = snapshot.val();
            
            // S'assurer que toutes les propri√©t√©s essentielles existent
            userData = {
                coins: loadedData.coins || defaultUserData.coins,
                gems: loadedData.gems || defaultUserData.gems,
                tokens: loadedData.tokens || defaultUserData.tokens,
                level: loadedData.level || defaultUserData.level,
                xp: loadedData.xp || defaultUserData.xp,
                
                // Nouvelle structure pour les joueurs
                players: loadedData.players || defaultUserData.players,
                
                // √âquipe avec conversion depuis ancien format si n√©cessaire
                team: convertTeamFormat(loadedData.team) || defaultUserData.team,
                
                formation: loadedData.formation || defaultUserData.formation,
                leaguePoints: loadedData.leaguePoints || defaultUserData.leaguePoints,
                matchesPlayed: loadedData.matchesPlayed || defaultUserData.matchesPlayed,
                wins: loadedData.wins || defaultUserData.wins,
                draws: loadedData.draws || defaultUserData.draws,
                losses: loadedData.losses || defaultUserData.losses,
                goalsScored: loadedData.goalsScored || defaultUserData.goalsScored,
                goalsConceded: loadedData.goalsConceded || defaultUserData.goalsConceded,
                badges: loadedData.badges || defaultUserData.badges,
                joinDate: loadedData.joinDate || defaultUserData.joinDate,
                weeklyMatches: loadedData.weeklyMatches || defaultUserData.weeklyMatches,
                ranking: loadedData.ranking || defaultUserData.ranking,
                
                // R√©compense quotidienne
                lastDailyReward: loadedData.lastDailyReward || null
            };
            
            console.log("Donn√©es utilisateur charg√©es avec succ√®s");
            
        } else {
            // Donn√©es par d√©faut pour les nouveaux utilisateurs
            userData = { ...defaultUserData };
            await saveUserData();
        }
        
        // Mettre √† jour l'interface
        updateUI();
        updateCollectionDisplay();
        
    } catch (error) {
        console.error("Erreur de chargement des donn√©es:", error);
        showNotification("Erreur de chargement des donn√©es", "error");
    }
}

// Convertir l'ancien format d'√©quipe au nouveau format
function convertTeamFormat(oldTeam) {
    if (!oldTeam) return null;
    
    // Si c'est d√©j√† le nouveau format (avec level), le retourner tel quel
    if (oldTeam.GK && typeof oldTeam.GK === 'object' && oldTeam.GK.level) {
        return oldTeam;
    }
    
    // Convertir l'ancien format (string) au nouveau format (objet avec level)
    const newTeam = {};
    for (const position in oldTeam) {
        const playerId = oldTeam[position];
        if (playerId) {
            newTeam[position] = {
                id: playerId,
                level: 1
            };
        }
    }
    
    return newTeam;
}

// Sauvegarder les donn√©es utilisateur
async function saveUserData() {
    if (!currentUser) return;
    
    try {
        await firebaseDb.ref(`users/${currentUser.uid}`).set(userData);
        console.log("Donn√©es sauvegard√©es avec succ√®s");
        
    } catch (error) {
        console.error("Erreur de sauvegarde:", error);
        showNotification("Erreur de sauvegarde des donn√©es", "error");
    }
}

// Mettre √† jour l'interface utilisateur
function updateUI() {
    // Utiliser des valeurs par d√©faut pour √©viter undefined
    const coins = userData.coins || 0;
    const gems = userData.gems || 0;
    const tokens = userData.tokens || 0;
    const level = userData.level || 1;
    const xp = userData.xp || 0;
    
    // Mettre √† jour les devises avec v√©rification
    document.getElementById("coins").textContent = coins.toLocaleString();
    document.getElementById("gems").textContent = gems.toLocaleString();
    document.getElementById("tokens").textContent = tokens.toLocaleString();
    
    // Mettre √† jour le niveau
    document.getElementById("player-level").textContent = "Niv. " + level;
    
    // Mettre √† jour la barre d'XP
    const xpNeeded = level * 100;
    const xpPercentage = xpNeeded > 0 ? (xp / xpNeeded) * 100 : 0;
    document.getElementById("xp-fill").style.width = `${Math.min(xpPercentage, 100)}%`;
}

// Mettre √† jour le tableau de bord
function updateDashboard() {
    updateUI();
    
    // Utiliser des valeurs par d√©faut pour √©viter undefined
    const wins = userData.wins || 0;
    const leaguePoints = userData.leaguePoints || 0;
    const playersCount = userData.players ? Object.keys(userData.players).length : 0;
    
    // Mettre √† jour les statistiques
    document.getElementById("stat-level").textContent = userData.level || 1;
    document.getElementById("stat-wins").textContent = wins;
    document.getElementById("stat-league-points").textContent = leaguePoints.toLocaleString();
    document.getElementById("stat-players").textContent = playersCount;
    
    // Mettre √† jour la progression de la ligue
    const progress = leaguePoints >= 1800 ? 100 : leaguePoints <= 800 ? 0 : ((leaguePoints - 800) / (1800 - 800)) * 100;
    document.getElementById("league-progress").style.width = `${Math.min(Math.max(progress, 0), 100)}%`;
    document.getElementById("current-points").textContent = leaguePoints.toLocaleString() + " pts";
}

// Initialiser les interfaces du jeu
function initializeGameInterfaces() {
    // Mettre √† jour le nom du joueur
    const userName = currentUser ? currentUser.email.split('@')[0] : "Joueur";
    document.getElementById("player-name").textContent = userName;
    document.getElementById("profile-name").textContent = userName;
    document.getElementById("profile-email").textContent = currentUser ? currentUser.email : "test@test.com";
    
    // Mettre √† jour la date d'adh√©sion
    const joinDate = userData.joinDate ? new Date(userData.joinDate) : new Date();
    document.getElementById("member-since").textContent = joinDate.toLocaleDateString('fr-FR');
    
    // Initialiser le timer de ligue
    updateLeagueTimer();
    setInterval(updateLeagueTimer, 60000);
}

// Initialiser les gestionnaires d'√©v√©nements
function initializeEventHandlers() {
    // Boutons de connexion
    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    document.getElementById("registerBtn").addEventListener("click", handleRegister);
    
    // Navigation principale
    document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const target = btn.dataset.target;
            showScreen(target);
            document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });
    
    // Navigation basse
    document.querySelectorAll(".bottom-nav-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const target = btn.dataset.target;
            if (target) {
                showScreen(target);
            }
        });
    });
    
    // Boutons rapides du dashboard
    document.getElementById("quick-play").addEventListener("click", () => playLeagueMatch());
    document.getElementById("quick-pack").addEventListener("click", () => showScreen("screen-store"));
    document.getElementById("quick-daily").addEventListener("click", claimDailyReward);
    document.getElementById("quick-ranking").addEventListener("click", () => showScreen("screen-ranking"));
    document.getElementById("play-next-match").addEventListener("click", playQuickMatch);
    document.getElementById("play-league-match").addEventListener("click", playLeagueMatch);
    
    // Bouton sauvegarder √©quipe
    document.getElementById("save-team").addEventListener("click", saveTeam);
    
    // Bouton d√©connexion
    document.getElementById("logout-btn").addEventListener("click", handleLogout);
    
    // Formation selector
    document.querySelectorAll(".formation-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const formation = btn.dataset.formation;
            userData.formation = formation;
            updateTeamDisplay();
            document.querySelectorAll(".formation-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });
    
    // Filtres de collection
    document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const filter = btn.dataset.filter;
            updateCollectionDisplay(filter);
            document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });
    
    // Boutons d'achat de packs
    document.querySelectorAll(".pack-card").forEach(card => {
        card.addEventListener("click", () => {
            const packType = card.dataset.pack;
            buyPack(packType);
        });
    });
    
    // Boutons d'achat de devises
    document.querySelectorAll(".buy-currency").forEach(btn => {
        btn.addEventListener("click", () => {
            const amount = parseInt(btn.dataset.amount);
            const price = parseInt(btn.dataset.price);
            buyCurrency(amount, price);
        });
    });
    
    // Boutons de fermeture des modals
    document.querySelectorAll(".close-modal").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".modal").forEach(modal => {
                modal.style.display = "none";
            });
        });
    });
    
    // Fermer les modals en cliquant √† l'ext√©rieur
    window.addEventListener("click", (event) => {
        if (event.target.classList.contains("modal")) {
            event.target.style.display = "none";
        }
    });
    
    // Bouton param√®tres
    document.getElementById("open-settings").addEventListener("click", () => {
        showNotification("Param√®tres - Fonctionnalit√© √† venir!", "info");
    });
}

// G√©rer la connexion
async function handleLogin() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
        showNotification("Veuillez entrer un email et un mot de passe", "error");
        return;
    }
    
    showLoading();
    
    try {
        await firebaseAuth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        hideLoading();
        console.error("Erreur de connexion:", error);
        
        let errorMessage = "Erreur de connexion";
        if (error.code === 'auth/user-not-found') {
            errorMessage = "Utilisateur non trouv√©";
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = "Mot de passe incorrect";
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = "Email invalide";
        }
        
        showNotification(errorMessage, "error");
    }
}

// G√©rer l'inscription
async function handleRegister() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
        showNotification("Veuillez entrer un email et un mot de passe", "error");
        return;
    }
    
    if (password.length < 6) {
        showNotification("Le mot de passe doit contenir au moins 6 caract√®res", "error");
        return;
    }
    
    showLoading();
    
    try {
        const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        
        // Initialiser les donn√©es utilisateur
        userData = { ...defaultUserData };
        await saveUserData();
        showNotification("Compte cr√©√© avec succ√®s!", "success");
        
    } catch (error) {
        hideLoading();
        console.error("Erreur d'inscription:", error);
        
        let errorMessage = "Erreur d'inscription";
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = "Cet email est d√©j√† utilis√©";
        } else if (error.code === 'auth/weak-password') {
            errorMessage = "Mot de passe trop faible";
        }
        
        showNotification(errorMessage, "error");
    }
}

// G√©rer la d√©connexion
async function handleLogout() {
    try {
        await firebaseAuth.signOut();
        showNotification("D√©connexion r√©ussie", "success");
    } catch (error) {
        console.error("Erreur de d√©connexion:", error);
    }
}

// Mettre √† jour l'affichage de l'√©quipe
function updateTeamDisplay() {
    const pitch = document.getElementById("football-pitch");
    const availableList = document.getElementById("available-players-list");
    const currentList = document.getElementById("current-team-list");
    
    // Vider les conteneurs
    pitch.innerHTML = '<div class="center-circle"></div>';
    availableList.innerHTML = '';
    currentList.innerHTML = '';
    
    // Obtenir la formation actuelle
    const formation = formations[userData.formation || "4-3-3"];
    
    // Cr√©er les emplacements de joueurs sur le terrain
    formation.positions.forEach((pos, index) => {
        const slot = document.createElement("div");
        slot.className = "player-slot";
        slot.style.left = `${pos.x}%`;
        slot.style.top = `${pos.y}%`;
        slot.dataset.position = pos.pos;
        slot.dataset.index = index;
        
        // Chercher le joueur dans cette position
        const teamPlayer = userData.team ? userData.team[pos.pos] : null;
        
        if (teamPlayer && teamPlayer.id) {
            const player = findPlayerById(teamPlayer.id);
            if (player) {
                // Calculer l'OVR avec bonus de niveau
                const boostedOverall = calculateBoostedOVR(player, teamPlayer.level);
                
                slot.innerHTML = `
                    <div class="position">${pos.pos}</div>
                    <div class="rating">${boostedOverall}</div>
                    <div style="font-size: 8px;">${player.name.split(' ')[0]}</div>
                    <div style="font-size: 8px; color: gold;">Lv.${teamPlayer.level}</div>
                `;
                slot.title = `${player.name} - OVR ${boostedOverall} (Niveau ${teamPlayer.level})`;
            }
        } else {
            slot.classList.add("empty");
            slot.innerHTML = `
                <div class="position">${pos.pos}</div>
                <div style="font-size: 12px;">+</div>
            `;
        }
        
        slot.addEventListener("click", () => openPlayerSelection(pos.pos));
        pitch.appendChild(slot);
    });
    
    // Remplir la liste des joueurs disponibles
    const playerIds = userData.players ? Object.keys(userData.players) : [];
    playerIds.forEach(playerId => {
        const playerData = userData.players[playerId];
        if (playerData && playerData.count > 0) {
            const player = findPlayerById(playerId);
            if (player && !isPlayerInTeam(playerId)) {
                const playerItem = document.createElement("div");
                playerItem.className = "player-item";
                playerItem.dataset.playerId = playerId;
                
                // Calculer l'OVR avec bonus de niveau
                const boostedOverall = calculateBoostedOVR(player, playerData.level);
                
                playerItem.innerHTML = `
                    <div class="player-info-small">
                        <div class="player-name">${player.name}</div>
                        <div class="player-details">${player.position} | ${player.club}</div>
                        <div class="player-details">Niv. ${playerData.level} | x${playerData.count}</div>
                    </div>
                    <div class="player-rating">${boostedOverall}</div>
                `;
                playerItem.addEventListener("click", () => openPlayerDetails(playerId));
                availableList.appendChild(playerItem);
            }
        }
    });
    
    // Remplir la liste de l'√©quipe actuelle
    if (userData.team) {
        Object.entries(userData.team).forEach(([position, teamPlayer]) => {
            if (teamPlayer && teamPlayer.id) {
                const player = findPlayerById(teamPlayer.id);
                if (player) {
                    const playerItem = document.createElement("div");
                    playerItem.className = "player-item";
                    playerItem.dataset.position = position;
                    playerItem.dataset.playerId = teamPlayer.id;
                    
                    // Calculer l'OVR avec bonus de niveau
                    const boostedOverall = calculateBoostedOVR(player, teamPlayer.level);
                    
                    playerItem.innerHTML = `
                        <div class="player-info-small">
                            <div class="player-name">${player.name}</div>
                            <div class="player-details">${position} | ${player.club}</div>
                            <div class="player-details">Niveau ${teamPlayer.level}</div>
                        </div>
                        <div class="player-rating">${boostedOverall}</div>
                    `;
                    playerItem.addEventListener("click", () => {
                        // Retirer le joueur de l'√©quipe
                        userData.team[position] = null;
                        updateTeamDisplay();
                        showNotification(`${player.name} retir√© de l'√©quipe`, "info");
                    });
                    currentList.appendChild(playerItem);
                }
            }
        });
    }
}

// Calculer l'OVR avec bonus de niveau
function calculateBoostedOVR(player, level) {
    if (!player || !level) return player?.overall || 0;
    
    // Chaque niveau ajoute 1-2 points √† l'OVR
    const boost = Math.min((level - 1) * 1.5, 10); // Max +10 points
    return Math.min(99, Math.round(player.overall + boost));
}

// V√©rifier si un joueur est dans l'√©quipe
function isPlayerInTeam(playerId) {
    if (!userData.team) return false;
    
    for (const position in userData.team) {
        const teamPlayer = userData.team[position];
        if (teamPlayer && teamPlayer.id === playerId) {
            return true;
        }
    }
    return false;
}

// Ouvrir la s√©lection de joueur pour une position
function openPlayerSelection(position) {
    // Cr√©er une liste modale des joueurs disponibles pour cette position
    let modalContent = `<h3 style="color: #00eaff; margin-bottom: 15px;">S√©lectionner un joueur pour ${position}</h3>`;
    
    const playerIds = userData.players ? Object.keys(userData.players) : [];
    const availablePlayers = [];
    
    playerIds.forEach(playerId => {
        const playerData = userData.players[playerId];
        if (playerData && playerData.count > 0 && !isPlayerInTeam(playerId)) {
            const player = findPlayerById(playerId);
            if (player) {
                // V√©rifier si le joueur peut jouer √† cette position
                if (isPlayerCompatibleWithPosition(player, position)) {
                    availablePlayers.push({
                        player,
                        playerData,
                        boostedOverall: calculateBoostedOVR(player, playerData.level)
                    });
                }
            }
        }
    });
    
    if (availablePlayers.length === 0) {
        modalContent += `<p style="text-align: center; color: #aaa;">Aucun joueur disponible pour cette position</p>`;
    } else {
        // Trier par OVR d√©croissant
        availablePlayers.sort((a, b) => b.boostedOverall - a.boostedOverall);
        
        availablePlayers.forEach(item => {
            const { player, playerData, boostedOverall } = item;
            modalContent += `
                <div class="player-item" style="margin-bottom: 10px; cursor: pointer;" onclick="selectPlayerForPosition('${player.id}', '${position}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <strong>${player.name}</strong><br>
                            <small>${player.position} | ${player.club} | OVR: ${boostedOverall} | Niv. ${playerData.level}</small>
                        </div>
                        <button style="background: #00eaff; border: none; color: #0a0a0f; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            S√©lectionner
                        </button>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById("player-modal-content").innerHTML = modalContent;
    document.getElementById("player-modal").style.display = "flex";
}

// S√©lectionner un joueur pour une position
function selectPlayerForPosition(playerId, position) {
    if (!userData.team) userData.team = {};
    
    const playerData = userData.players[playerId];
    if (!playerData || playerData.count === 0) {
        showNotification("Ce joueur n'est pas disponible!", "error");
        return;
    }
    
    userData.team[position] = {
        id: playerId,
        level: playerData.level || 1
    };
    
    updateTeamDisplay();
    document.getElementById("player-modal").style.display = "none";
    
    const player = findPlayerById(playerId);
    showNotification(`${player.name} ajout√© √† la position ${position}`, "success");
}

// V√©rifier si un joueur est compatible avec une position
function isPlayerCompatibleWithPosition(player, position) {
    const positionGroups = {
        GK: ["GK"],
        DEF: ["RB", "RWB", "CB", "LB", "LWB"],
        MID: ["CDM", "CM", "CAM", "RM", "LM"],
        ATT: ["RW", "LW", "ST", "CF"]
    };
    
    for (const [group, positions] of Object.entries(positionGroups)) {
        if (positions.includes(position)) {
            // Pour simplifier, on v√©rifie si la position du joueur correspond au groupe
            const playerGroup = Object.entries(positionGroups).find(([g, pos]) => 
                pos.includes(player.position)
            );
            return playerGroup && playerGroup[0] === group;
        }
    }
    
    return false;
}

// Sauvegarder l'√©quipe
function saveTeam() {
    saveUserData();
    showNotification("√âquipe sauvegard√©e avec succ√®s!", "success");
}

// Mettre √† jour l'affichage de la collection
function updateCollectionDisplay(filter = "all") {
    const container = document.getElementById("collection-players");
    container.innerHTML = '';
    
    const playerIds = userData.players ? Object.keys(userData.players) : [];
    
    playerIds.forEach(playerId => {
        const playerData = userData.players[playerId];
        if (playerData && playerData.count > 0) {
            const player = findPlayerById(playerId);
            if (player) {
                // Appliquer les filtres
                if (filter !== "all") {
                    if (filter === "common" && player.rarity !== "common") return;
                    if (filter === "rare" && player.rarity !== "rare") return;
                    if (filter === "epic" && player.rarity !== "epic") return;
                    if (filter === "legendary" && player.rarity !== "legendary") return;
                    if (filter === "att" && !["ST", "CF", "RW", "LW"].includes(player.position)) return;
                    if (filter === "mid" && !["CM", "CAM", "CDM", "RM", "LM"].includes(player.position)) return;
                    if (filter === "def" && !["CB", "RB", "LB", "RWB", "LWB"].includes(player.position)) return;
                    if (filter === "gk" && player.position !== "GK") return;
                }
                
                const playerCard = document.createElement("div");
                playerCard.className = `player-card player-rare-${player.rarity}`;
                playerCard.dataset.playerId = playerId;
                
                // Raret√© en √©toiles
                let stars = "";
                switch(player.rarity) {
                    case "common": stars = "‚òÖ"; break;
                    case "rare": stars = "‚òÖ‚òÖ"; break;
                    case "epic": stars = "‚òÖ‚òÖ‚òÖ"; break;
                    case "legendary": stars = "‚òÖ‚òÖ‚òÖ‚òÖ"; break;
                }
                
                // Calculer l'OVR avec bonus
                const boostedOverall = calculateBoostedOVR(player, playerData.level);
                
                playerCard.innerHTML = `
                    <div class="player-photo">
                        ${player.name.split(' ')[0].charAt(0)}${player.name.split(' ')[1] ? player.name.split(' ')[1].charAt(0) : ''}
                        ${playerData.count > 1 ? `<div style="position: absolute; top: -5px; right: -5px; background: gold; color: #000; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px;">x${playerData.count}</div>` : ''}
                    </div>
                    <h4>${player.name}</h4>
                    <div style="font-size: 12px; color: #aaa;">${player.position} | ${player.club}</div>
                    <div style="font-size: 14px; font-weight: bold; margin: 5px 0; color: ${player.rarity === 'common' ? '#aaa' : player.rarity === 'rare' ? '#00eaff' : player.rarity === 'epic' ? '#8e38ff' : 'gold'}">
                        ${stars} OVR ${boostedOverall}
                    </div>
                    <div style="font-size: 11px; color: gold;">Niv. ${playerData.level}</div>
                    <div class="player-stats">
                        <div class="stat-item">
                            <div class="stat-value-small">${player.pac}</div>
                            <div class="stat-label-small">PAC</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value-small">${player.sho}</div>
                            <div class="stat-label-small">SHO</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value-small">${player.pas}</div>
                            <div class="stat-label-small">PAS</div>
                        </div>
                    </div>
                `;
                
                playerCard.addEventListener("click", () => openPlayerDetails(playerId));
                container.appendChild(playerCard);
            }
        }
    });
    
    if (container.children.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #aaa;">
                ${filter === "all" ? "Aucun joueur dans votre collection" : "Aucun joueur ne correspond aux filtres s√©lectionn√©s"}
            </div>
        `;
    }
}

// Ouvrir les d√©tails d'un joueur
function openPlayerDetails(playerId) {
    const player = findPlayerById(playerId);
    if (!player) return;
    
    const playerData = userData.players[playerId];
    if (!playerData) return;
    
    // Calculer l'OVR avec bonus
    const boostedOverall = calculateBoostedOVR(player, playerData.level);
    const isInTeam = isPlayerInTeam(playerId);
    const teamPosition = isInTeam ? getPlayerPositionInTeam(playerId) : null;
    
    let modalContent = `
        <div style="text-align: center;">
            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #6d00ff, #00eaff); display: inline-flex; align-items: center; justify-content: center; font-size: 36px; margin-bottom: 20px; position: relative;">
                ${player.name.split(' ')[0].charAt(0)}${player.name.split(' ')[1] ? player.name.split(' ')[1].charAt(0) : ''}
                ${playerData.count > 1 ? `<div style="position: absolute; top: -5px; right: -5px; background: gold; color: #000; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;">x${playerData.count}</div>` : ''}
            </div>
            <h3 style="color: #00eaff; margin-bottom: 10px;">${player.name}</h3>
            <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(0,234,255,0.1); padding: 8px 15px; border-radius: 20px;">
                    ${player.position}
                </div>
                <div style="background: rgba(109,0,255,0.1); padding: 8px 15px; border-radius: 20px;">
                    ${player.club}
                </div>
                <div style="background: rgba(255,215,0,0.1); padding: 8px 15px; border-radius: 20px; color: gold;">
                    OVR ${boostedOverall}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                <div style="text-align: left;">
                    <h4 style="color: #00eaff; margin-bottom: 10px;">Statistiques</h4>
                    <div style="background: rgba(26,26,37,0.8); padding: 15px; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Pace:</span>
                            <span style="font-weight: bold; color: #00eaff;">${player.pac}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Shooting:</span>
                            <span style="font-weight: bold; color: #00eaff;">${player.sho}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Passing:</span>
                            <span style="font-weight: bold; color: #00eaff;">${player.pas}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Dribbling:</span>
                            <span style="font-weight: bold; color: #00eaff;">${player.dri}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Defending:</span>
                            <span style="font-weight: bold; color: #00eaff;">${player.def}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Physical:</span>
                            <span style="font-weight: bold; color: #00eaff;">${player.phy}</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: left;">
                    <h4 style="color: #00eaff; margin-bottom: 10px;">Informations</h4>
                    <div style="background: rgba(26,26,37,0.8); padding: 15px; border-radius: 10px;">
                        <div style="margin-bottom: 8px;">
                            <div style="color: #aaa; font-size: 12px;">Nationalit√©</div>
                            <div style="font-weight: bold;">${player.nation}</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div style="color: #aaa; font-size: 12px;">Raret√©</div>
                            <div style="font-weight: bold; color: ${player.rarity === 'common' ? '#aaa' : player.rarity === 'rare' ? '#00eaff' : player.rarity === 'epic' ? '#8e38ff' : 'gold'}">
                                ${player.rarity.charAt(0).toUpperCase() + player.rarity.slice(1)}
                            </div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div style="color: #aaa; font-size: 12px;">Niveau</div>
                            <div style="font-weight: bold; color: gold;">${playerData.level}</div>
                        </div>
                        <div>
                            <div style="color: #aaa; font-size: 12px;">Dans votre collection</div>
                            <div style="font-weight: bold; color: #00eaff;">${playerData.count} exemplaire(s)</div>
                        </div>
                    </div>
                </div>
            </div>
    `;
    
    // V√©rifier si le joueur est dans l'√©quipe
    if (isInTeam && teamPosition) {
        const teamPlayer = userData.team[teamPosition];
        modalContent += `
            <div style="margin-top: 20px; padding: 15px; background: rgba(0,255,0,0.1); border-radius: 10px; border: 2px solid #00ff00;">
                <i class="fas fa-check-circle" style="color: #00ff00; margin-right: 10px;"></i>
                Ce joueur est actuellement dans votre √©quipe (${teamPosition}) - Niveau ${teamPlayer.level}
            </div>
        `;
    }
    
    // Bouton pour fusionner si on a plusieurs exemplaires
    if (playerData.count >= 2 && isInTeam) {
        modalContent += `
            <button onclick="fusePlayerManually('${playerId}')" 
                    style="margin-top: 20px; background: gold; border: none; color: #000; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%;">
                <i class="fas fa-sync-alt"></i> Fusionner (${playerData.count-1} copie(s) disponible(s))
            </button>
        `;
    }
    
    modalContent += `</div>`;
    
    document.getElementById("player-modal-content").innerHTML = modalContent;
    document.getElementById("player-modal").style.display = "flex";
}

// Obtenir la position d'un joueur dans l'√©quipe
function getPlayerPositionInTeam(playerId) {
    if (!userData.team) return null;
    
    for (const position in userData.team) {
        const teamPlayer = userData.team[position];
        if (teamPlayer && teamPlayer.id === playerId) {
            return position;
        }
    }
    return null;
}

// Fusionner manuellement un joueur
function fusePlayerManually(playerId) {
    const playerData = userData.players[playerId];
    if (!playerData || playerData.count < 2) {
        showNotification("Pas assez de copies pour fusionner!", "error");
        return;
    }
    
    const position = getPlayerPositionInTeam(playerId);
    if (!position) {
        showNotification("Ce joueur n'est pas dans votre √©quipe!", "error");
        return;
    }
    
    // R√©duire le compteur
    playerData.count--;
    
    // Augmenter le niveau du joueur dans l'√©quipe
    userData.team[position].level++;
    
    // Mettre √† jour le niveau maximum dans la collection
    if (playerData.level < userData.team[position].level) {
        playerData.level = userData.team[position].level;
    }
    
    // Sauvegarder
    saveUserData();
    updateTeamDisplay();
    updateCollectionDisplay();
    
    // Afficher l'animation de fusion
    showFusionAnimation(playerId, userData.team[position].level);
    
    // Fermer le modal
    document.getElementById("player-modal").style.display = "none";
}

// Afficher l'animation de fusion
function showFusionAnimation(playerId, newLevel) {
    const player = findPlayerById(playerId);
    const fusionContent = document.getElementById("fusion-content");
    
    fusionContent.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">
            <i class="fas fa-sync-alt fa-spin" style="color: gold;"></i>
        </div>
        <h3 style="color: gold; margin-bottom: 20px;">Fusion R√©ussie!</h3>
        
        <div style="display: flex; align-items: center; justify-content: center; gap: 30px; margin: 30px 0;">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #6d00ff, #00eaff); display: inline-flex; align-items: center; justify-content: center; font-size: 24px;">
                    ${player.name.split(' ')[0].charAt(0)}${player.name.split(' ')[1] ? player.name.split(' ')[1].charAt(0) : ''}
                </div>
                <div style="margin-top: 10px; font-weight: bold;">${player.name}</div>
                <div style="font-size: 14px; color: #aaa;">Niveau ${newLevel-1}</div>
            </div>
            
            <div style="font-size: 36px; color: gold;">+</div>
            
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #ffaa00, gold); display: inline-flex; align-items: center; justify-content: center; font-size: 24px;">
                    <i class="fas fa-plus"></i>
                </div>
                <div style="margin-top: 10px; font-weight: bold;">Copie</div>
                <div style="font-size: 14px; color: #aaa;">Fusion</div>
            </div>
            
            <div style="font-size: 36px; color: gold;">‚Üí</div>
            
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, gold, #ffaa00); display: inline-flex; align-items: center; justify-content: center; font-size: 24px; border: 3px solid gold;">
                    ${player.name.split(' ')[0].charAt(0)}${player.name.split(' ')[1] ? player.name.split(' ')[1].charAt(0) : ''}
                </div>
                <div style="margin-top: 10px; font-weight: bold;">${player.name}</div>
                <div style="font-size: 16px; color: gold; font-weight: bold;">Niveau ${newLevel}!</div>
            </div>
        </div>
        
        <div style="background: rgba(255,215,0,0.1); border-radius: 10px; padding: 15px; margin-top: 20px; border: 2px solid gold;">
            <div style="font-weight: bold; color: gold;">Bonus de niveau:</div>
            <div style="font-size: 14px; color: #aaa;">OVR augment√© de +${Math.min((newLevel - 1) * 1.5, 10).toFixed(1)} points</div>
        </div>
        
        <button onclick="document.getElementById('fusion-modal').style.display='none'" 
                style="margin-top: 30px; background: gold; border: none; color: #000; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
            Continuer
        </button>
    `;
    
    document.getElementById("fusion-modal").style.display = "flex";
}

// Acheter un pack
function buyPack(packType) {
    const packPrices = {
        bronze: { coins: 500, gems: 0 },
        silver: { coins: 1500, gems: 0 },
        gold: { gems: 50, coins: 0 },
        legendary: { gems: 150, coins: 0 }
    };
    
    const packContents = {
        bronze: { count: 3, guaranteed: "rare" },
        silver: { count: 5, guaranteed: "epic" },
        gold: { count: 7, guaranteed: "legendary" },
        legendary: { count: 10, guaranteed: "legendary", guaranteedCount: 3 }
    };
    
    const price = packPrices[packType];
    const content = packContents[packType];
    
    // V√©rifier si l'utilisateur a assez d'argent
    if (price.coins > 0 && (userData.coins || 0) < price.coins) {
        showNotification("Pas assez de coins!", "error");
        return;
    }
    if (price.gems > 0 && (userData.gems || 0) < price.gems) {
        showNotification("Pas assez de gems!", "error");
        return;
    }
    
    // D√©duire le prix
    if (price.coins > 0) userData.coins = (userData.coins || 0) - price.coins;
    if (price.gems > 0) userData.gems = (userData.gems || 0) - price.gems;
    
    // G√©n√©rer les joueurs
    const players = [];
    const rarities = ["common", "rare", "epic", "legendary"];
    
    // Joueur(s) garanti(s)
    if (content.guaranteedCount) {
        for (let i = 0; i < content.guaranteedCount; i++) {
            const playerList = footballPlayersDB[content.guaranteed];
            const randomPlayer = playerList[Math.floor(Math.random() * playerList.length)];
            players.push({ ...randomPlayer });
            
            // Ajouter √† la collection avec fusion automatique
            addPlayerToCollection(randomPlayer.id);
        }
    } else {
        const playerList = footballPlayersDB[content.guaranteed];
        const randomPlayer = playerList[Math.floor(Math.random() * playerList.length)];
        players.push({ ...randomPlayer });
        addPlayerToCollection(randomPlayer.id);
    }
    
    // G√©n√©rer les joueurs restants
    const remainingCount = content.count - (content.guaranteedCount || 1);
    const rarityWeights = {
        bronze: { common: 0.7, rare: 0.25, epic: 0.04, legendary: 0.01 },
        silver: { common: 0.5, rare: 0.35, epic: 0.12, legendary: 0.03 },
        gold: { common: 0.2, rare: 0.3, epic: 0.4, legendary: 0.1 },
        legendary: { common: 0.05, rare: 0.15, epic: 0.3, legendary: 0.5 }
    };
    
    const weights = rarityWeights[packType];
    
    for (let i = 0; i < remainingCount; i++) {
        const rand = Math.random();
        let selectedRarity = "common";
        
        if (rand < weights.common) selectedRarity = "common";
        else if (rand < weights.common + weights.rare) selectedRarity = "rare";
        else if (rand < weights.common + weights.rare + weights.epic) selectedRarity = "epic";
        else selectedRarity = "legendary";
        
        const playerList = footballPlayersDB[selectedRarity];
        const randomPlayer = playerList[Math.floor(Math.random() * playerList.length)];
        players.push({ ...randomPlayer });
        
        // Ajouter √† la collection avec fusion automatique
        addPlayerToCollection(randomPlayer.id);
    }
    
    // Ajouter de l'XP
    addXP(25);
    
    // Sauvegarder et mettre √† jour
    saveUserData();
    updateDashboard();
    updateCollectionDisplay();
    
    // Afficher les r√©sultats
    showPackResults(players, packType);
}

// Ajouter un joueur √† la collection AVEC FUSION AUTOMATIQUE
function addPlayerToCollection(playerId) {
    if (!userData.players) userData.players = {};
    if (!userData.players[playerId]) {
        userData.players[playerId] = { count: 1, level: 1 };
    } else {
        // Doublon - augmenter le compteur
        const playerData = userData.players[playerId];
        playerData.count++;
        
        // Fusion automatique si le joueur est dans l'√©quipe
        if (isPlayerInTeam(playerId)) {
            // Trouver la position du joueur dans l'√©quipe
            for (const position in userData.team) {
                const teamPlayer = userData.team[position];
                if (teamPlayer && teamPlayer.id === playerId) {
                    // Utiliser une copie pour la fusion
                    if (playerData.count >= 2) {
                        playerData.count--;
                        teamPlayer.level++;
                        
                        // Mettre √† jour le niveau maximum dans la collection
                        if (playerData.level < teamPlayer.level) {
                            playerData.level = teamPlayer.level;
                        }
                        
                        // Notification
                        const player = findPlayerById(playerId);
                        showNotification(`Fusion automatique: ${player.name} +1 niveau (Niv. ${teamPlayer.level})`, "success");
                    }
                    break;
                }
            }
        }
    }
    
    // V√©rifier les badges
    checkBadges();
}

// Afficher les r√©sultats d'un pack
function showPackResults(players, packType) {
    const packNames = {
        bronze: "BRONZE",
        silver: "ARGENT",
        gold: "OR",
        legendary: "L√âGENDAIRE"
    };
    
    document.getElementById("pack-modal-title").textContent = `PACK ${packNames[packType]} OUVERT!`;
    
    const resultsContainer = document.getElementById("pack-results");
    resultsContainer.innerHTML = '';
    
    let hasFusion = false;
    let fusionPlayers = [];
    
    players.forEach((player, index) => {
        setTimeout(() => {
            const playerCard = document.createElement("div");
            playerCard.className = "player-card";
            
            // V√©rifier si c'est un doublon et si le joueur est dans l'√©quipe
            const playerData = userData.players[player.id];
            const isDuplicate = playerData && playerData.count > 1;
            const isInTeam = isPlayerInTeam(player.id);
            
            if (isDuplicate && isInTeam) {
                playerCard.style.borderColor = "#00ff00";
                playerCard.style.boxShadow = "0 0 20px #00ff00";
                hasFusion = true;
                fusionPlayers.push(player);
            } else {
                playerCard.style.borderColor = player.rarity === "common" ? "#aaa" : 
                                              player.rarity === "rare" ? "#00eaff" : 
                                              player.rarity === "epic" ? "#8e38ff" : "gold";
            }
            
            playerCard.style.animation = "none";
            playerCard.style.opacity = "0";
            playerCard.style.transform = "scale(0.8)";
            
            // Raret√© en √©toiles
            let stars = "";
            switch(player.rarity) {
                case "common": stars = "‚òÖ"; break;
                case "rare": stars = "‚òÖ‚òÖ"; break;
                case "epic": stars = "‚òÖ‚òÖ‚òÖ"; break;
                case "legendary": stars = "‚òÖ‚òÖ‚òÖ‚òÖ"; break;
            }
            
            playerCard.innerHTML = `
                <div class="player-photo" style="width: 60px; height: 60px; font-size: 24px; position: relative;">
                    ${player.name.split(' ')[0].charAt(0)}${player.name.split(' ')[1] ? player.name.split(' ')[1].charAt(0) : ''}
                    ${isDuplicate && isInTeam ? '<div style="position: absolute; top: -5px; right: -5px; background: #00ff00; color: #000; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">F</div>' : ''}
                </div>
                <h4 style="font-size: 14px;">${player.name}</h4>
                <div style="font-size: 11px; color: #aaa;">${player.position}</div>
                <div style="font-size: 12px; font-weight: bold; margin: 5px 0; color: ${player.rarity === 'common' ? '#aaa' : player.rarity === 'rare' ? '#00eaff' : player.rarity === 'epic' ? '#8e38ff' : 'gold'}">
                    ${stars} OVR ${player.overall}
                </div>
                ${isDuplicate && isInTeam ? '<div style="color: #00ff00; font-size: 11px; margin-top: 5px;">‚úì Fusion automatique</div>' : ''}
            `;
            
            resultsContainer.appendChild(playerCard);
            
            // Animation d'apparition
            setTimeout(() => {
                playerCard.style.transition = "all 0.5s ease";
                playerCard.style.opacity = "1";
                playerCard.style.transform = "scale(1)";
            }, 50);
            
        }, index * 200);
    });
    
    // Afficher un message sp√©cial pour la fusion
    if (hasFusion) {
        setTimeout(() => {
            const fusionMessage = document.createElement("div");
            fusionMessage.style.gridColumn = "1/-1";
            fusionMessage.style.textAlign = "center";
            fusionMessage.style.padding = "15px";
            fusionMessage.style.background = "rgba(0,255,0,0.1)";
            fusionMessage.style.borderRadius = "10px";
            fusionMessage.style.border = "2px solid #00ff00";
            fusionMessage.style.marginTop = "20px";
            fusionMessage.innerHTML = `
                <h4 style="color: #00ff00; margin-bottom: 5px;">
                    <i class="fas fa-sync-alt"></i> Fusion automatique
                </h4>
                <p style="font-size: 14px; color: #aaa;">
                    Les joueurs doublons ont √©t√© fusionn√©s automatiquement!
                    Vos joueurs dans l'√©quipe ont gagn√© +1 niveau.
                </p>
            `;
            resultsContainer.appendChild(fusionMessage);
        }, players.length * 200 + 500);
    }
    
    document.getElementById("pack-modal").style.display = "flex";
}

// Acheter des devises
function buyCurrency(amount, price) {
    if ((userData.gems || 0) < price) {
        showNotification("Pas assez de gems!", "error");
        return;
    }
    
    userData.gems = (userData.gems || 0) - price;
    userData.coins = (userData.coins || 0) + amount;
    
    saveUserData();
    updateDashboard();
    
    showNotification(`Achat r√©ussi! +${amount} coins`, "success");
}

// R√©clamer la r√©compense quotidienne - CORRIG√â
function claimDailyReward() {
    const today = new Date().toISOString().split('T')[0];
    
    // V√©rifier si le joueur a d√©j√† r√©clam√© sa r√©compense aujourd'hui
    if (userData.lastDailyReward === today) {
        showNotification("Vous avez d√©j√† r√©clam√© votre r√©compense aujourd'hui!", "error");
        return;
    }
    
    const rewardCoins = 100 + ((userData.level || 1) * 10);
    const rewardGems = Math.floor((userData.level || 1) / 3) + 1;
    
    userData.coins = (userData.coins || 0) + rewardCoins;
    userData.gems = (userData.gems || 0) + rewardGems;
    userData.lastDailyReward = today;
    
    saveUserData();
    updateDashboard();
    
    showNotification(`R√©compense quotidienne: +${rewardCoins} coins, +${rewardGems} gems!`, "success");
}

// Jouer un match rapide
function playQuickMatch() {
    playMatch(false);
}

// Jouer un match de ligue
function playLeagueMatch() {
    playMatch(true);
}

// Jouer un match
function playMatch(isLeagueMatch) {
    // V√©rifier que l'√©quipe est compl√®te
    if (!userData.team) {
        showNotification("Votre √©quipe n'est pas configur√©e!", "error");
        return;
    }
    
    const emptyPositions = Object.values(userData.team).filter(player => !player || !player.id).length;
    if (emptyPositions > 0) {
        showNotification(`Votre √©quipe n'est pas compl√®te! ${emptyPositions} position(s) vacante(s).`, "error");
        return;
    }
    
    // Calculer la force de l'√©quipe avec bonus de niveau
    let teamStrength = 0;
    let playerCount = 0;
    
    Object.values(userData.team).forEach(teamPlayer => {
        if (teamPlayer && teamPlayer.id) {
            const player = findPlayerById(teamPlayer.id);
            if (player) {
                const boostedOverall = calculateBoostedOVR(player, teamPlayer.level);
                teamStrength += boostedOverall;
                playerCount++;
            }
        }
    });
    
    if (playerCount === 0) {
        showNotification("Votre √©quipe est vide!", "error");
        return;
    }
    
    const avgStrength = teamStrength / playerCount;
    
    // G√©n√©rer une force adverse bas√©e sur le niveau du joueur
    const opponentStrength = avgStrength + (Math.random() * 10 - 5); // +/- 5 points
    
    // Simuler le match
    const playerScore = Math.floor(Math.random() * 4); // 0-3 buts
    const opponentScore = Math.floor(Math.random() * 4); // 0-3 buts
    
    // Ajuster selon la force relative
    const strengthDiff = avgStrength - opponentStrength;
    const adjustedPlayerScore = Math.max(0, Math.min(5, playerScore + Math.floor(strengthDiff / 10)));
    const adjustedOpponentScore = Math.max(0, Math.min(5, opponentScore - Math.floor(strengthDiff / 10)));
    
    // D√©terminer le r√©sultat
    let result, points, coins, xp;
    
    if (adjustedPlayerScore > adjustedOpponentScore) {
        result = "VICTOIRE";
        points = isLeagueMatch ? 3 : 1;
        coins = 200;
        xp = 50;
        userData.wins = (userData.wins || 0) + 1;
    } else if (adjustedPlayerScore < adjustedOpponentScore) {
        result = "D√âFAITE";
        points = 0;
        coins = 50;
        xp = 20;
        userData.losses = (userData.losses || 0) + 1;
    } else {
        result = "MATCH NUL";
        points = isLeagueMatch ? 1 : 0;
        coins = 100;
        xp = 30;
        userData.draws = (userData.draws || 0) + 1;
    }
    
    // Mettre √† jour les statistiques
    userData.matchesPlayed = (userData.matchesPlayed || 0) + 1;
    userData.goalsScored = (userData.goalsScored || 0) + adjustedPlayerScore;
    userData.goalsConceded = (userData.goalsConceded || 0) + adjustedOpponentScore;
    userData.coins = (userData.coins || 0) + coins;
    
    if (isLeagueMatch) {
        userData.leaguePoints = (userData.leaguePoints || 0) + points;
        
        // Ajouter le match √† l'historique de la semaine
        const matchRecord = {
            date: new Date().toISOString(),
            result: result,
            score: `${adjustedPlayerScore}-${adjustedOpponentScore}`,
            points: points
        };
        
        if (!userData.weeklyMatches) {
            userData.weeklyMatches = [];
        }
        userData.weeklyMatches.push(matchRecord);
        
        // Garder seulement les 10 derniers matchs
        if (userData.weeklyMatches.length > 10) {
            userData.weeklyMatches = userData.weeklyMatches.slice(-10);
        }
    }
    
    // Ajouter XP et v√©rifier le niveau
    addXP(xp);
    
    // V√©rifier les badges
    checkBadges();
    
    // Sauvegarder et mettre √† jour
    saveUserData();
    updateDashboard();
    updateWeeklyMatches();
    
    // Afficher le r√©sultat
    showMatchResult(result, adjustedPlayerScore, adjustedOpponentScore, coins, xp, isLeagueMatch ? points : 0);
}

// Afficher le r√©sultat d'un match
function showMatchResult(result, playerScore, opponentScore, coins, xp, points) {
    const resultContent = document.getElementById("match-result-content");
    
    let resultColor = "#00eaff";
    let resultIcon = "‚öΩ";
    
    if (result === "VICTOIRE") {
        resultColor = "#00ff00";
        resultIcon = "üèÜ";
    } else if (result === "D√âFAITE") {
        resultColor = "#ff4444";
        resultIcon = "üò¢";
    }
    
    resultContent.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">${resultIcon}</div>
        <h3 style="color: ${resultColor}; margin-bottom: 20px; font-size: 28px;">${result}!</h3>
        
        <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin: 30px 0;">
            <div style="text-align: center;">
                <div style="font-size: 14px; color: #aaa;">Votre √âquipe</div>
                <div style="font-size: 48px; font-weight: bold; color: #00eaff;">${playerScore}</div>
            </div>
            <div style="font-size: 24px; font-weight: bold;">-</div>
            <div style="text-align: center;">
                <div style="font-size: 14px; color: #aaa;">Adversaire</div>
                <div style="font-size: 48px; font-weight: bold; color: #ff4444;">${opponentScore}</div>
            </div>
        </div>
        
        <div style="background: rgba(26,26,37,0.8); border-radius: 12px; padding: 20px; margin-top: 20px;">
            <h4 style="color: #00eaff; margin-bottom: 15px;">R√©compenses</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #aaa;">Coins</div>
                    <div style="font-size: 24px; font-weight: bold; color: gold;">+${coins}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #aaa;">XP</div>
                    <div style="font-size: 24px; font-weight: bold; color: #00eaff;">+${xp}</div>
                </div>
                ${points > 0 ? `
                <div style="text-align: center; grid-column: 1/-1;">
                    <div style="font-size: 12px; color: #aaa;">Points de Ligue</div>
                    <div style="font-size: 24px; font-weight: bold; color: #8e38ff;">+${points}</div>
                </div>
                ` : ''}
            </div>
        </div>
        
        <button onclick="document.getElementById('match-modal').style.display='none'" 
                style="margin-top: 30px; background: #00eaff; border: none; color: #0a0a0f; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
            Continuer
        </button>
    `;
    
    document.getElementById("match-modal").style.display = "flex";
}

// Ajouter de l'XP
function addXP(amount) {
    userData.xp = (userData.xp || 0) + amount;
    const level = userData.level || 1;
    const xpNeeded = level * 100;
    
    if (userData.xp >= xpNeeded) {
        userData.level = level + 1;
        userData.xp = userData.xp - xpNeeded;
        userData.coins = (userData.coins || 0) + (userData.level * 100);
        userData.gems = (userData.gems || 0) + Math.floor(userData.level / 2);
        
        showNotification(`Level Up! Vous √™tes maintenant niveau ${userData.level}`, "success");
    }
}

// Mettre √† jour le timer de la ligue
function updateLeagueTimer() {
    const now = new Date();
    const nextSunday = new Date();
    
    // Trouver le prochain dimanche √† 00:00
    nextSunday.setDate(now.getDate() + (7 - now.getDay()) % 7);
    nextSunday.setHours(0, 0, 0, 0);
    
    // Si aujourd'hui est dimanche et qu'il est avant minuit, prendre aujourd'hui
    if (now.getDay() === 0 && now.getHours() < 24) {
        nextSunday.setDate(now.getDate());
    }
    
    const diff = nextSunday - now;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    document.getElementById("league-timer").textContent = 
        `Reset dans: ${days}j ${hours}h ${minutes}m`;
    
    // R√©initialiser les matches hebdomadaires si c'est dimanche minuit
    if (now.getDay() === 0 && now.getHours() === 0 && now.getMinutes() < 1) {
        userData.weeklyMatches = [];
        saveUserData();
        updateWeeklyMatches();
    }
}

// Mettre √† jour l'affichage des matches hebdomadaires
function updateWeeklyMatches() {
    const container = document.getElementById("weekly-matches");
    container.innerHTML = '';
    
    if (!userData.weeklyMatches || userData.weeklyMatches.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #aaa;">
                Aucun match jou√© cette semaine
            </div>
        `;
        return;
    }
    
    userData.weeklyMatches.forEach((match, index) => {
        const matchCard = document.createElement("div");
        matchCard.className = `match-card match-result ${match.result.toLowerCase()}`;
        
        const scores = match.score.split('-');
        const playerScore = parseInt(scores[0]);
        const opponentScore = parseInt(scores[1]);
        
        matchCard.innerHTML = `
            <div class="match-teams">
                <div style="font-weight: bold;">Vous</div>
                <div class="vs">VS</div>
                <div>Adversaire</div>
            </div>
            <div class="match-score">${playerScore} - ${opponentScore}</div>
            <div style="font-weight: bold; color: ${match.result === 'VICTOIRE' ? '#00ff00' : match.result === 'D√âFAITE' ? '#ff4444' : '#00eaff'}">
                ${match.result}
            </div>
        `;
        
        container.appendChild(matchCard);
    });
}

// Mettre √† jour le classement global - AVEC VRAIS JOUEURS
async function updateGlobalRanking() {
    try {
        const snapshot = await firebaseDb.ref('users').once('value');
        const rankingContainer = document.getElementById("global-ranking");
        rankingContainer.innerHTML = '';
        
        if (!snapshot.exists()) {
            rankingContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #aaa;">
                    Aucun joueur dans le classement
                </div>
            `;
            return;
        }
        
        const allUsers = [];
        snapshot.forEach(childSnapshot => {
            const user = childSnapshot.val();
            if (user && user.leaguePoints !== undefined) {
                allUsers.push({
                    uid: childSnapshot.key,
                    name: user.email ? user.email.split('@')[0] : "Joueur",
                    points: user.leaguePoints || 0,
                    level: user.level || 1,
                    wins: user.wins || 0
                });
            }
        });
        
        // Trier par points d√©croissants
        allUsers.sort((a, b) => b.points - a.points);
        
        // Afficher les 50 premiers
        const topUsers = allUsers.slice(0, 50);
        
        topUsers.forEach((player, index) => {
            const rankItem = document.createElement("div");
            const isYou = currentUser && player.uid === currentUser.uid;
            rankItem.className = `ranking-item ${isYou ? "you" : ""}`;
            
            rankItem.innerHTML = `
                <div class="rank ${index < 3 ? `rank-${index + 1}` : ''}">${index + 1}</div>
                <div class="player-rank-info">
                    <div class="player-rank-name">${player.name}</div>
                    <div class="player-rank-team">Niv. ${player.level} | ${player.wins} victoires</div>
                </div>
                <div class="player-rank-points">${player.points.toLocaleString()}</div>
            `;
            
            rankingContainer.appendChild(rankItem);
            
            // Mettre √† jour la position de l'utilisateur
            if (isYou) {
                userData.ranking = index + 1;
                document.getElementById("your-ranking").innerHTML = `
                    <div style="font-size: 36px; color: #00eaff;">#${index + 1}</div>
                    <div style="font-size: 14px; color: #aaa;">sur ${allUsers.length} joueurs</div>
                `;
            }
        });
        
        // Sauvegarder le classement
        saveUserData();
        
    } catch (error) {
        console.error("Erreur de chargement du classement:", error);
        // Afficher un classement simul√© en cas d'erreur
        showMockRanking();
    }
}

// Afficher un classement simul√© (fallback)
function showMockRanking() {
    const rankingContainer = document.getElementById("global-ranking");
    rankingContainer.innerHTML = '';
    
    // Classement simul√©
    const mockRanking = [
        { name: "Champion123", points: 2450, level: 25, wins: 120 },
        { name: "FootballPro", points: 2380, level: 24, wins: 115 },
        { name: "GoldenBoot", points: 2310, level: 23, wins: 110 },
        { name: currentUser ? currentUser.email.split('@')[0] : "Joueur", points: userData.leaguePoints || 0, level: userData.level || 1, wins: userData.wins || 0 },
        { name: "Striker99", points: 2150, level: 22, wins: 105 },
        { name: "DefenseKing", points: 2080, level: 21, wins: 100 },
        { name: "MidfieldMaestro", points: 2010, level: 20, wins: 95 },
        { name: "GoalieGod", points: 1950, level: 19, wins: 90 },
        { name: "TacticalGenius", points: 1880, level: 18, wins: 85 },
        { name: "UltimateManager", points: 1810, level: 17, wins: 80 }
    ];
    
    // Trier par points
    mockRanking.sort((a, b) => b.points - a.points);
    
    mockRanking.forEach((player, index) => {
        const rankItem = document.createElement("div");
        const isYou = player.name === (currentUser ? currentUser.email.split('@')[0] : "Joueur");
        rankItem.className = `ranking-item ${isYou ? "you" : ""}`;
        
        rankItem.innerHTML = `
            <div class="rank ${index < 3 ? `rank-${index + 1}` : ''}">${index + 1}</div>
            <div class="player-rank-info">
                <div class="player-rank-name">${player.name}</div>
                <div class="player-rank-team">Niv. ${player.level} | ${player.wins} victoires</div>
            </div>
            <div class="player-rank-points">${player.points.toLocaleString()}</div>
        `;
        
        rankingContainer.appendChild(rankItem);
        
        // Mettre √† jour la position de l'utilisateur
        if (isYou) {
            document.getElementById("your-ranking").innerHTML = `
                <div style="font-size: 36px; color: #00eaff;">#${index + 1}</div>
                <div style="font-size: 14px; color: #aaa;">sur 10 000 joueurs</div>
            `;
        }
    });
}

// Mettre √† jour le profil
function updateProfile() {
    // Mettre √† jour les statistiques du profil
    document.getElementById("profile-matches").textContent = userData.matchesPlayed || 0;
    
    const matchesPlayed = userData.matchesPlayed || 0;
    const wins = userData.wins || 0;
    const winrate = matchesPlayed > 0 ? 
        Math.round((wins / matchesPlayed) * 100) : 0;
    document.getElementById("profile-winrate").textContent = winrate + "%";
    
    document.getElementById("profile-goals").textContent = userData.goalsScored || 0;
    document.getElementById("profile-goals-conceded").textContent = userData.goalsConceded || 0;
    
    // Mettre √† jour les badges
    updateBadgesDisplay();
}

// Mettre √† jour l'affichage des badges
function updateBadgesDisplay() {
    const container = document.getElementById("profile-badges");
    container.innerHTML = '';
    
    badges.forEach(badge => {
        const badgeElement = document.createElement("div");
        const hasBadge = userData.badges ? userData.badges.includes(badge.id) : badge.id === "badge_rookie";
        badgeElement.className = `badge ${hasBadge ? "unlocked" : ""}`;
        badgeElement.title = `${badge.name}: ${badge.description}`;
        badgeElement.innerHTML = badge.icon;
        container.appendChild(badgeElement);
    });
}

// V√©rifier les badges
function checkBadges() {
    const newBadges = [];
    
    // Badge: Premi√®re victoire
    if ((userData.wins || 0) >= 1 && userData.badges && !userData.badges.includes("badge_first_win")) {
        newBadges.push("badge_first_win");
    }
    
    // Badge: 10 victoires
    if ((userData.wins || 0) >= 10 && userData.badges && !userData.badges.includes("badge_10wins")) {
        newBadges.push("badge_10wins");
    }
    
    // Badge: 50 victoires
    if ((userData.wins || 0) >= 50 && userData.badges && !userData.badges.includes("badge_50wins")) {
        newBadges.push("badge_50wins");
    }
    
    // Badge: Collectionneur (20 joueurs)
    const playerCount = userData.players ? Object.keys(userData.players).length : 0;
    if (playerCount >= 20 && userData.badges && !userData.badges.includes("badge_collector")) {
        newBadges.push("badge_collector");
    }
    
    // Badge: Millionnaire (10 000 coins)
    if ((userData.coins || 0) >= 10000 && userData.badges && !userData.badges.includes("badge_rich")) {
        newBadges.push("badge_rich");
    }
    
    // Badge: Ligue Diamant (1800 points)
    if ((userData.leaguePoints || 0) >= 1800 && userData.badges && !userData.badges.includes("badge_league")) {
        newBadges.push("badge_league");
    }
    
    // Ajouter les nouveaux badges
    if (newBadges.length > 0) {
        if (!userData.badges) userData.badges = ["badge_rookie"];
        newBadges.forEach(badgeId => {
            if (!userData.badges.includes(badgeId)) {
                userData.badges.push(badgeId);
                const badge = badges.find(b => b.id === badgeId);
                if (badge) {
                    showNotification(`Nouveau badge d√©bloqu√©: ${badge.name}!`, "success");
                }
            }
        });
        updateBadgesDisplay();
    }
}

// Trouver un joueur par son ID
function findPlayerById(playerId) {
    for (const rarity in footballPlayersDB) {
        const player = footballPlayersDB[rarity].find(p => p.id === playerId);
        if (player) return player;
    }
    return null;
}

// Afficher un √©cran
function showScreen(screenId) {
    // Cacher tous les √©crans
    document.querySelectorAll(".screen").forEach(screen => {
        screen.classList.remove("active");
    });
    
    // Afficher l'√©cran demand√©
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
        targetScreen.classList.add("active");
    }
}

// Afficher une notification
function showNotification(message, type = "info") {
    // Supprimer les notifications existantes
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement("div");
    notification.className = "notification";
    notification.textContent = message;
    
    if (type === "success") {
        notification.style.borderColor = "#00ff00";
    } else if (type === "error") {
        notification.style.borderColor = "#ff4444";
    } else if (type === "warning") {
        notification.style.borderColor = "#ffaa00";
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Afficher le loading
function showLoading() {
    document.getElementById("loading").style.display = "flex";
}

// Cacher le loading
function hideLoading() {
    document.getElementById("loading").style.display = "none";
}

// Initialiser l'application au chargement
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    
    // Cacher le loading apr√®s 2 secondes max
    setTimeout(hideLoading, 2000);
});

// Exposer certaines fonctions au global scope pour les √©v√©nements onclick
window.selectPlayerForPosition = selectPlayerForPosition;
window.fusePlayerManually = fusePlayerManually;
</script>

</body>
</html>
